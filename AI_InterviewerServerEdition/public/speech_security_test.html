<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­éŸ³è¯†åˆ«å®‰å…¨ä¸Šä¸‹æ–‡æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”’ è¯­éŸ³è¯†åˆ«å®‰å…¨ä¸Šä¸‹æ–‡æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>1. å®‰å…¨ä¸Šä¸‹æ–‡æ£€æµ‹</h2>
        <div id="securityContext" class="status"></div>
        <div id="protocol" class="status"></div>
        <div id="origin" class="status"></div>
    </div>

    <div class="test-section">
        <h2>2. Web Speech API å¯ç”¨æ€§</h2>
        <div id="apiAvailability" class="status"></div>
        <div id="apiDetails" class="status"></div>
    </div>

    <div class="test-section">
        <h2>3. è¯­éŸ³è¯†åˆ«æµ‹è¯•</h2>
        <button id="testButton" onclick="testSpeechRecognition()">æµ‹è¯•è¯­éŸ³è¯†åˆ«</button>
        <div id="testResult" class="status" style="display:none;"></div>
        <pre id="testLog" style="display:none;"></pre>
    </div>

    <div class="test-section">
        <h2>4. è§£å†³æ–¹æ¡ˆ</h2>
        <div id="solution" class="status info"></div>
    </div>

    <script>
        // æ£€æµ‹å®‰å…¨ä¸Šä¸‹æ–‡
        function checkSecurityContext() {
            const isSecure = window.isSecureContext;
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const origin = window.location.origin;
            
            // æ˜¾ç¤ºå®‰å…¨ä¸Šä¸‹æ–‡çŠ¶æ€
            document.getElementById('securityContext').className = `status ${isSecure ? 'success' : 'error'}`;
            document.getElementById('securityContext').textContent = 
                `å®‰å…¨ä¸Šä¸‹æ–‡: ${isSecure ? 'âœ… æ˜¯' : 'âŒ å¦'}`;
            
            // æ˜¾ç¤ºåè®®
            document.getElementById('protocol').className = `status ${protocol === 'https:' ? 'success' : 'warning'}`;
            document.getElementById('protocol').textContent = 
                `å½“å‰åè®®: ${protocol} ${protocol === 'https:' ? 'âœ…' : 'âš ï¸'}`;
            
            // æ˜¾ç¤ºæ¥æº
            document.getElementById('origin').className = 'status info';
            document.getElementById('origin').textContent = `å½“å‰æ¥æº: ${origin}`;
            
            // ç‰¹æ®Šæƒ…å†µè¯´æ˜
            if (!isSecure && hostname === 'localhost') {
                document.getElementById('origin').innerHTML += 
                    '<br>ğŸ’¡ æ³¨æ„: localhost é€šå¸¸è¢«è§†ä¸ºå®‰å…¨ä¸Šä¸‹æ–‡ï¼Œä½†æŸäº›åŠŸèƒ½å¯èƒ½ä»å—é™';
            } else if (!isSecure) {
                document.getElementById('origin').innerHTML += 
                    '<br>âš ï¸ è­¦å‘Š: éå®‰å…¨ä¸Šä¸‹æ–‡å¯èƒ½å¯¼è‡´è¯­éŸ³è¯†åˆ«åŠŸèƒ½å—é™æˆ–ä¸å¯ç”¨ï¼';
            }
            
            return isSecure;
        }

        // æ£€æµ‹ Web Speech API
        function checkWebSpeechAPI() {
            const hasSpeechRecognition = 'SpeechRecognition' in window || 'webkitSpeechRecognition' in window;
            const hasGetUserMedia = navigator.mediaDevices && navigator.mediaDevices.getUserMedia;
            
            document.getElementById('apiAvailability').className = `status ${hasSpeechRecognition ? 'success' : 'error'}`;
            document.getElementById('apiAvailability').textContent = 
                `Web Speech API: ${hasSpeechRecognition ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}`;
            
            let details = [];
            if ('SpeechRecognition' in window) details.push('æ ‡å‡†API âœ…');
            if ('webkitSpeechRecognition' in window) details.push('WebKit API âœ…');
            if (hasGetUserMedia) details.push('getUserMedia âœ…');
            
            document.getElementById('apiDetails').className = 'status info';
            document.getElementById('apiDetails').innerHTML = `æ”¯æŒçš„åŠŸèƒ½: ${details.join(', ')}`;
            
            return hasSpeechRecognition;
        }

        // æµ‹è¯•è¯­éŸ³è¯†åˆ«
        async function testSpeechRecognition() {
            const button = document.getElementById('testButton');
            const result = document.getElementById('testResult');
            const log = document.getElementById('testLog');
            
            button.disabled = true;
            result.style.display = 'block';
            log.style.display = 'block';
            
            let logs = [];
            const addLog = (msg) => {
                logs.push(`[${new Date().toLocaleTimeString()}] ${msg}`);
                log.textContent = logs.join('\n');
            };
            
            try {
                addLog('å¼€å§‹æµ‹è¯•è¯­éŸ³è¯†åˆ«...');
                
                // æ£€æŸ¥å®‰å…¨ä¸Šä¸‹æ–‡
                if (!window.isSecureContext) {
                    addLog('âš ï¸ è­¦å‘Š: ä¸åœ¨å®‰å…¨ä¸Šä¸‹æ–‡ä¸­ï¼Œè¯­éŸ³è¯†åˆ«å¯èƒ½å¤±è´¥');
                }
                
                // åˆ›å»ºè¯­éŸ³è¯†åˆ«å®ä¾‹
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    throw new Error('æµè§ˆå™¨ä¸æ”¯æŒ Web Speech API');
                }
                
                const recognition = new SpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.continuous = false;
                recognition.interimResults = true;
                
                addLog('âœ… åˆ›å»ºè¯­éŸ³è¯†åˆ«å®ä¾‹æˆåŠŸ');
                addLog(`é…ç½®: è¯­è¨€=${recognition.lang}, è¿ç»­=${recognition.continuous}`);
                
                // è®¾ç½®äº‹ä»¶å¤„ç†
                recognition.onstart = () => {
                    addLog('ğŸ¤ è¯­éŸ³è¯†åˆ«å·²å¯åŠ¨');
                    result.className = 'status info';
                    result.textContent = 'æ­£åœ¨å½•éŸ³ï¼Œè¯·è¯´è¯...';
                };
                
                recognition.onaudiostart = () => {
                    addLog('ğŸ”Š éŸ³é¢‘æ•è·å¼€å§‹');
                };
                
                recognition.onspeechstart = () => {
                    addLog('ğŸ—£ï¸ æ£€æµ‹åˆ°è¯­éŸ³');
                };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    addLog(`ğŸ“ è¯†åˆ«ç»“æœ: "${transcript}"`);
                    result.className = 'status success';
                    result.textContent = `è¯†åˆ«æˆåŠŸ: "${transcript}"`;
                };
                
                recognition.onerror = (event) => {
                    addLog(`âŒ é”™è¯¯: ${event.error}`);
                    result.className = 'status error';
                    
                    let errorMsg = `è¯†åˆ«å¤±è´¥: ${event.error}`;
                    if (event.error === 'not-allowed') {
                        errorMsg += ' - éº¦å…‹é£æƒé™è¢«æ‹’ç»';
                    } else if (event.error === 'network') {
                        errorMsg += ' - ç½‘ç»œé”™è¯¯ï¼Œå¯èƒ½éœ€è¦HTTPS';
                    } else if (event.error === 'no-speech') {
                        errorMsg += ' - æœªæ£€æµ‹åˆ°è¯­éŸ³';
                    }
                    
                    result.textContent = errorMsg;
                    
                    // ç‰¹æ®Šå¤„ç†ï¼šéå®‰å…¨ä¸Šä¸‹æ–‡
                    if (!window.isSecureContext) {
                        addLog('ğŸ’¡ æç¤º: åœ¨HTTPç¯å¢ƒä¸‹ï¼Œè¯­éŸ³è¯†åˆ«å¯èƒ½è¢«æµè§ˆå™¨é™åˆ¶');
                    }
                };
                
                recognition.onend = () => {
                    addLog('ğŸ è¯­éŸ³è¯†åˆ«ç»“æŸ');
                    button.disabled = false;
                };
                
                // å¯åŠ¨è¯†åˆ«
                addLog('æ­£åœ¨å¯åŠ¨è¯­éŸ³è¯†åˆ«...');
                recognition.start();
                
            } catch (error) {
                addLog(`âŒ å¼‚å¸¸: ${error.message}`);
                result.className = 'status error';
                result.textContent = `æµ‹è¯•å¤±è´¥: ${error.message}`;
                button.disabled = false;
            }
        }

        // æ˜¾ç¤ºè§£å†³æ–¹æ¡ˆ
        function showSolution() {
            const isSecure = window.isSecureContext;
            const solution = document.getElementById('solution');
            
            if (isSecure) {
                solution.innerHTML = `
                    <h3>âœ… æ‚¨çš„ç¯å¢ƒæ˜¯å®‰å…¨çš„</h3>
                    <p>è¯­éŸ³è¯†åˆ«åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œã€‚å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š</p>
                    <ul>
                        <li>éº¦å…‹é£æƒé™æ˜¯å¦å·²æˆäºˆ</li>
                        <li>éº¦å…‹é£è®¾å¤‡æ˜¯å¦æ­£å¸¸</li>
                        <li>æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼ˆæ¨èChromeæˆ–Edgeï¼‰</li>
                    </ul>
                `;
            } else {
                solution.innerHTML = `
                    <h3>âš ï¸ æ£€æµ‹åˆ°éå®‰å…¨ä¸Šä¸‹æ–‡é—®é¢˜</h3>
                    <p>æ‚¨å½“å‰ä½¿ç”¨çš„æ˜¯ HTTP åè®®ï¼Œè¿™ä¼šå¯¼è‡´è¯­éŸ³è¯†åˆ«åŠŸèƒ½å—é™ã€‚è§£å†³æ–¹æ¡ˆï¼š</p>
                    <ol>
                        <li><strong>ä½¿ç”¨ HTTPS</strong>: é…ç½®SSLè¯ä¹¦ï¼Œé€šè¿‡ https:// è®¿é—®</li>
                        <li><strong>ä½¿ç”¨ localhost</strong>: è®¿é—® http://localhost:5000 è€Œä¸æ˜¯IPåœ°å€</li>
                        <li><strong>ä½¿ç”¨ ngrok</strong>: åˆ›å»ºå®‰å…¨çš„éš§é“æ¥æµ‹è¯•</li>
                        <li><strong>éƒ¨ç½²åˆ°æ”¯æŒHTTPSçš„æœåŠ¡å™¨</strong>: å¦‚Vercelã€Netlifyç­‰</li>
                    </ol>
                    <p style="color: #dc3545;">
                        <strong>é‡è¦</strong>: å¤§å¤šæ•°ç°ä»£æµè§ˆå™¨åœ¨éHTTPSç¯å¢ƒä¸‹ä¼šé˜»æ­¢æˆ–é™åˆ¶è¯­éŸ³è¯†åˆ«APIï¼
                    </p>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œæ£€æµ‹
        window.onload = function() {
            checkSecurityContext();
            checkWebSpeechAPI();
            showSolution();
        };
    </script>
</body>
</html> 